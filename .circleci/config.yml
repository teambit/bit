version: 2.1

default_image: &default_image
  docker:
    - image: circleci/node:12.15.0

default_resource_class: &default_resource_class
  resource_class: medium

windows_default_resource_size: &windows_default_resource_size
  size: medium

default_working_dir: &default_working_dir
  working_directory: ~/bit

windows_default_working_dir: &windows_default_working_dir
  working_directory: C:\Users\circleci\project\bit

windows_default_executor_name: &windows_default_executor_name
  name: win/default

windows_default_executor: &windows_default_executor
  executor:
    <<: *windows_default_executor_name
    <<: *windows_default_resource_size

windows_defaults: &windows_defaults
  <<: *windows_default_executor
  <<: *windows_default_working_dir

mac_default_xcode_version: &mac_default_xcode_version
  xcode: 11.5.0

mac_default_executor: &mac_default_executor
  macos:
    <<: *mac_default_xcode_version

mac_defaults: &mac_defaults
  <<: *mac_default_executor

defaults: &defaults
  <<: *default_image
  <<: *default_resource_class
  <<: *default_working_dir

semver_tags_only_filters: &semver_tags_only_filters
  filters:
    # ignore any commit on any branch by default
    branches:
      ignore: /.*/
    # only act on version tags
    tags:
      only: /^v[0-9]+(\.[0-9]+)*$/

master_only_filter: &master_only_filter
  filters:
    branches:
      only: master

nightly_tag_only_filters: &nightly_tag_only_filters
  filters:
    # ignore any commit on any branch by default
    branches:
      ignore: /.*/
    # only act on version tags
    tags:
      only: /manual-nightly/

dev_tag_only_filters: &dev_tag_only_filters
  filters:
    # ignore any commit on any branch by default
    branches:
      ignore: /.*/
    # only act on version tags
    tags:
      only: /^dev$/

commands: # reusable commands
  bit_config:
    parameters:
      env:
        default: 'hub-stg'
        # default: 'hub'
        type: string
      token:
        default: $BIT_DEV_PROD_TOKEN
        type: string
    steps:
      - run: 'bit config set analytics_reporting false'
      - run: 'bit config set error_reporting false'
      - run: 'bit config set user.name tester'
      - run: 'bit config set user.email ci@bit.dev'
      # - run: 'bit config set user.token <<parameters.token>>'
      - run: 'bit config set hub_domain <<parameters.env>>.bit.dev'
      - run: 'bit config set package-manager.cache /home/circleci/package-manager-cache'

  bit_global_for_npm:
    steps:
      - run:
          name: 'create npm global dir'
          command: 'mkdir -p /home/circleci/.npm-global/bin'
      - run:
          name: 'link bit to path'
          command: 'ln -sf /home/circleci/bit/bit/bin/bit.js /home/circleci/.npm-global/bin/bit'
      - run: "echo 'export PATH=~/.npm-global/bin:$PATH' >> $BASH_ENV"
      - run: which bit

  update_ssh_agent:
    steps:
      - # add the id_rsa to ssh_agent to make sure we authenticate with the correct user
        run: 'chmod 400 ~/.ssh/id_rsa'
      - run: 'ssh-add ~/.ssh/id_rsa'

  set_git_credentials:
    steps:
      - run:
          name: 'set GitHub token'
          command: export GH_RELEASE_GITHUB_API_TOKEN=$ghToken
      - add_ssh_keys:
          fingerprints:
            - 'SHA256:fF5QridDUgTXkn8xIMZQNbn9sPN5QhNhc3jr8y8e2LI ci@bit.dev'
      - run:
          name: set git user.name and user.email
          command: 'git config --global user.email "ci@bit.dev" && git config --global user.name "CircleCI"'
      # - run:
      #     name: 'replace git protocol from ssh to http' # to not get the authenticate error
      #     command: sed -i 's/git@github.com:teambit\/bit.git/https:\/\/github.com\/teambit\/bit.git/g' .git/config
      # - run: mkdir -p ~/.ssh
      # - run: SCAN=$(ssh-keyscan github.com )
      # - run: echo $SCAN >> ~/.ssh/known_hosts
      - run: cd bit && git remote rm origin
      # todo: find a better way. currently, the ssh doesn't work, see the commented steps above.
      - run: cd bit && git remote add origin https://davidfirst:$GH_RELEASE_GITHUB_API_TOKEN@github.com/teambit/bit.git


orbs:
  win: circleci/windows@2.4.0

jobs:
  checkout_code:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: 'save SHA to a file'
          command: 'echo $CIRCLE_SHA1 > .circle-sha'
      - persist_to_workspace:
          root: /home/circleci
          paths:
            - bit

  docker_build:
    machine: true
    steps:
      - attach_workspace:
          at: ./
      - run: echo "$DOCKER_PASS" | docker login --username $DOCKER_USER --password-stdin
      - run: cd bit/scripts && docker build -f ./docker-teambit-bit/Dockerfile -t bitcli/bit:`npm show @teambit/bit version` .
      - run: cd bit/scripts && docker build -f ./docker-teambit-bit/Dockerfile -t bitcli/bit:latest .
      - run: cd bit && docker push bitcli/bit:`npm show @teambit/bit version`
      - run: cd bit && docker push bitcli/bit:latest

  set_ssh_key:
    <<: *defaults
    working_directory: ~/.ssh
    steps:
      - run: 'echo "-----BEGIN RSA PRIVATE KEY-----" >> ~/.ssh/id_rsa'
      - run: 'echo ${testerBitsrcSSHPrivateKey} >> id_rsa'
      - run: 'echo "-----END RSA PRIVATE KEY-----" >> ~/.ssh/id_rsa'
      - run: 'echo ${testerBitsrcSSHPublicKey} >> id_rsa.pub'
      - save_cache:
          key: bitsrc-ssh-key3
          paths:
            - ~/.ssh/id_rsa
            - ~/.ssh/id_rsa.pub

  set_npm_registries:
    <<: *defaults
    steps:
      # - run:
      #     name: setting npmjs regisry
      #     command: echo "//registry.npmjs.org/:_authToken=${npmjsRegistryToken}" >> ~/.npmrc
      # - run: npm whoami
      # prod registry
      - run: npm config set @bit:registry https://node.bit.dev
      - run: echo "//node.bit.dev/:_authToken=$registryProdToken" >> ~/.npmrc
      - run: echo "always-auth=true" >> ~/.npmrc
      # stage registry
      # -
      # run: 'npm config set @bit:registry https://node-stg.bit.dev'
      # -
      # run: 'echo "//node-stg.bit.dev/:_authToken=$registryStgToken" >> ~/.npmrc'
      - save_cache:
          key: bitsrc-registry8
          # key: bitsrc-registry-stg-v2
          paths:
            - ~/.npmrc

  validate-git-tag-and-version:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Setup bit version environment variables
          command: cd bit && echo "export BIT_VERSION=$(cat ./package.json | jq .version -r)" >> $BASH_ENV && source $BASH_ENV
      - run:
          name: 'installing semver tool'
          command: 'sudo npm i -g semver'
      - run:
          name: 'validate version in package.json does not contains pre release tags'
          # This will return code 1 when the version contains pre release tags
          command: 'semver $BIT_VERSION -r x.x.x'
      - run:
          name: 'validate tag match version in package.json'
          command: 'cd bit && ./scripts/compare-versions.sh $CIRCLE_TAG v$BIT_VERSION'

  build:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./

      - run:
          name: 'save SHA to a file'
          command: 'echo $CIRCLE_SHA1 > .circle-sha'
      - run:
          name: 'Build bit source code'
          command: 'cd bit && npm run build'
      - persist_to_workspace:
          root: .
          paths:
            - bit/dist

  pack:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run: 'sudo npm i -g pkg@4.4.6'
      # -
      #   run:
      #     name: 'save pkg targets names'
      #     command: 'cat ./bit/package.json | jq .scripts.pkg:all | sed -E "s/^.*--targets (.*) -.*$/\1/" > /home/circleci/pkg-target.txt'
      - restore_cache:
          keys:
            # - 'pkg-cache-v3-{{ checksum "/home/circleci/pkg-target.txt" }}'
            - pkg-cache-v3
      - run:
          name: 'set pkg path'
          command: "echo 'export PKG_CACHE_PATH=/home/circleci/pkg-cache' >> $BASH_ENV"
      - run:
          name: 'Pack bit'
          command: 'cd bit && npm run pkg:all'
      # -
      #   save_cache:
      #     key: 'pkg-cache-v3-{{ checksum "/home/circleci/pkg-target.txt" }}'
      #     paths:
      #       - ~/pkg-cache
      - save_cache:
          key: pkg-cache-v3
          paths:
            - /home/circleci/pkg-cache
      # -
      #   run:
      #     name: 'copy unsuported files'
      #     command: 'cd bit && cp ./node_modules/open/xdg-open ./releases/xdg-open'
      - persist_to_workspace:
          root: .
          paths:
            - bit/releases

  npm-publish:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Authenticate with registry
          command: echo "//registry.npmjs.org/:_authToken=$npmToken" > ~/.npmrc
      - run:
          name: Publish bit to the npm registry
          command: 'cd bit && npm publish'

  github-release:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run: 'cd bit && npm run release:circle'

  github-pre-release:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run: 'cd bit && npm run pre-release:circle'

  build-debian:
    <<: *defaults
    docker:
      - image: 'bitcli/debian-artifact-builder:latest'
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Build debian file
          command: 'cd bit && ./scripts/linux/debian/build-linux-deb.sh'
      - persist_to_workspace:
          root: .
          paths:
            - bit/releases/deb

  build-rpm:
    <<: *defaults
    docker:
      - image: 'bitcli/rpm-artifact-builder:latest'
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Build rpm file
          command: 'cd bit && ./scripts/linux/centos/build-linux-rpm.sh'
      - persist_to_workspace:
          root: .
          paths:
            - bit/releases/rpm

  publish_to_jfrog:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: print bit version
          command: cd bit && cat ./package.json | jq .version -r
      - run:
          name: Setup bit version environment variables
          command: cd bit && echo "export BIT_VERSION=$(cat ./package.json | jq .version -r)" >> $BASH_ENV && source $BASH_ENV
      - run:
          name: Install jFrog CLI
          command: curl -fL https://getcli.jfrog.io | sh
      - run:
          name: Configure jfrog auth
          command: ./jfrog rt config --url $jfrogUrl --user $jfrogUser --access-token $jfrogAcessToken --interactive=false
      - run:
          name: Upload debian file
          command: ./jfrog rt u "bit/releases/deb/*.deb" bit-deb/stable/${BIT_VERSION}/bit_${BIT_VERSION}_amd64.deb --build-name bit_${BIT_VERSION}_amd64.deb --build-number $CIRCLE_BUILD_NUM --deb "all/stable/amd64" --flat=false
      - run:
          name: Upload rpm file
          command: ./jfrog rt u "bit/releases/rpm/*.rpm" bit-yum/stable/bit/${BIT_VERSION}/bit-${BIT_VERSION}-${CIRCLE_BUILD_NUM}.x86_64.rpm --flat=false
  # this should be unified with the prod version and get params for dev

  publish_to_jfrog_dev:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: print bit version
          command: cd bit && cat ./package.json | jq .version -r
      - run:
          name: Setup bit version environment variables
          command: cd bit && echo "export BIT_VERSION=$(cat ./package.json | jq .version -r)" >> $BASH_ENV && source $BASH_ENV
      - run:
          name: Install jFrog CLI
          command: curl -fL https://getcli.jfrog.io | sh
      - run:
          name: Configure jfrog auth
          command: ./jfrog rt config --url $jfrogUrl --user $jfrogUser --access-token $jfrogAcessToken --interactive=false
      - run:
          name: Upload debian file
          command: ./jfrog rt u "bit/releases/deb/*.deb" bit-deb/development/${BIT_VERSION}/bit_${BIT_VERSION}_amd64.deb --build-name bit_${BIT_VERSION}_amd64.deb --build-number $CIRCLE_BUILD_NUM --deb "all/development/amd64" --flat=false
      - run:
          name: Upload rpm file
          command: ./jfrog rt u "bit/releases/rpm/*.rpm" bit-yum/development/bit/${BIT_VERSION}/bit-${BIT_VERSION}-${CIRCLE_BUILD_NUM}.x86_64.rpm --flat=false

  generate_docs:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: 'generate docs'
          command: 'cd bit && npm run doc-gen'
      - run:
          name: Setup genereate doc build number environment variables
          command: echo "$CIRCLE_BUILD_NUM" > DOC_GEN_BUILD_NUM.txt
      - store_artifacts:
          path: bit/dist/cli.md
      - persist_to_workspace:
          root: .
          paths:
            - DOC_GEN_BUILD_NUM.txt

  slack_deploy_notification:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Setup genereate doc build number environment variable
          command: echo "export DOC_GEN_BUILD_NUM=$(cat DOC_GEN_BUILD_NUM.txt)" >> $BASH_ENV && source $BASH_ENV
      - run:
          name: 'notify slack'
          command: 'cd bit && node ./scripts/slack-deploy-notification.js'
      - run:
          name: 'notify community slack'
          command: 'cd bit && node ./scripts/slack-deploy-notification.js community'

  unit_test:
    <<: *defaults
    steps:
      - run:
          name: 'save SHA to a file'
          command: 'echo $CIRCLE_SHA1 > .circle-sha'
      - attach_workspace:
          at: ./
      - run: 'cd bit && mkdir junit'
      - run:
          name: 'Run unit tests'
          command: 'cd bit && npm run test-circle'
          environment:
            MOCHA_FILE: junit/unit-test-results.xml
          when: always
      - store_test_results:
          path: bit/junit
      - store_artifacts:
          path: bit/junit

  lint:
    <<: *defaults
    resource_class: medium
    steps:
      - run:
          name: 'save SHA to a file'
          command: 'echo $CIRCLE_SHA1 > .circle-sha'
      - restore_cache:
          keys:
            - 'repo-{{ checksum ".circle-sha" }}'
      - attach_workspace:
          at: ./
      - run:
          name: 'run ESLint'
          command: 'cd bit && npm run lint-circle'
      - store_test_results:
          path: bit/junit
      - store_artifacts:
          path: bit/junit

  generate_and_check_types:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: 'generate types'
          command: 'cd bit && npm run build:types'
      - run:
          name: 'run TSC'
          command: 'cd bit && npm run check-types'
      - persist_to_workspace:
          root: .
          paths:
            - bit/dist

  setup_harmony:
    resource_class: large
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - restore_cache:
          key: bitsrc-registry8
      - run:
          name: 'install husky globally'
          command: 'sudo npm i -g husky'
      - run:
          name: 'install harmony'
          command: 'cd bit && npm run install-harmony'
      # - run:
      #     name: 'import objects'
      #     command: 'cd bit && npm run import-harmony'
      - run:
          name: 'build harmony'
          command: 'cd bit && npm run build-harmony'
          no_output_timeout: '20m'
      - run:
          name: 'status harmony'
          command: 'cd bit && npm run status-harmony'
      - run:
          name: 'Build bit source code'
          command: 'cd bit && npm run build'
      - run:
          name: 'Build bit-legacy types'
          command: 'cd bit && npm run build:types'
      - persist_to_workspace:
          root: .
          paths:
            - bit
            - .pnpm-store
      - store_artifacts:
          path: ~/Library/Caches/Bit/logs
      - store_artifacts:
          path: bit/yarn.lock

  bit_build:
    resource_class: large
    <<: *defaults
    environment:
      # change the npm config to avoid using sudo
      NPM_CONFIG_PREFIX: ~/.npm-global
    steps:
      - attach_workspace:
          at: ./
      - bit_global_for_npm
      - bit_config
      - restore_cache:
          key: bitsrc-ssh-key3
      - restore_cache:
          key: bitsrc-registry8
      # - update_ssh_agent
      - run:
          name: 'bit status'
          command: 'cd bit && bit status'
      # run second time until we do real bit export
      - run:
          name: 'bit status'
          command: 'cd bit && ./scripts/bit-status.sh'
      - run:
          name: 'bit build'
          command: 'cd bit && bit build'
          environment:
            NODE_OPTIONS: --max_old_space_size=4096

  bit_tag:
    resource_class: large
    <<: *defaults
    environment:
      # change the npm config to avoid using sudo
      NPM_CONFIG_PREFIX: ~/.npm-global
    steps:
      - attach_workspace:
          at: ./
      - bit_global_for_npm
      - bit_config:
          env: "hub"
      - restore_cache:
          key: bitsrc-ssh-key3
      - restore_cache:
          key: bitsrc-registry8
      - update_ssh_agent
      - set_git_credentials
      - run:
          name: setting npmjs registry with publishing permission
          command: echo "//registry.npmjs.org/:_authToken=${npmjsRegistryToken}" >> ~/.npmrc
      - run: cd bit && node scripts/bump-bit-legacy-ver.js
      - run: cd bit && build-harmony/node_modules/.bin/bbit status
      # temporarily. otherwise it fails on bit-checkout during Yarn installation with "Error: ENOENT: no such file or directory, chmod '/home/******ci/bit/bit/node_modules/@teambit/legacy/node_modules/@babel/core/node_modules/semver/bin/semver'""
      - run: cd bit && rm -rf node_modules
      - run: cd bit && build-harmony/node_modules/.bin/bbit checkout latest --all --skip-npm-install
      # - run: cd bit && rm -rf node_modules/@teambit/legacy
      # - run: cd bit && build-harmony/node_modules/.bin/bbit checkout latest --all
      # - run: cd bit && npm run link-bit-legacy
      # since we removed the node_modules we need to make sure we compile, install and link everything again
      - run:
          name: 'build harmony'
          command: 'cd bit && npm run build-harmony-skip-import'
      # - run: cd bit && node scripts/soft-tag-scope-teambit.js
      - run:
          name: tag persist
          # command: cd bit && bit tag --all --ignore-newest-version
          # command: cd bit && bit tag --scope 0.0.297
          # command: cd bit && bit tag --all --increment-by 2
          command: cd bit && bit tag --all
          # command: cd bit && bit tag --persist --ignore-newest-version
          no_output_timeout: '25m'
          environment:
            NODE_OPTIONS: --max_old_space_size=4096
      - run:
          name: backup bit objects (before export)
          command: cd bit && tar -zcvf objects-before-export.tar .git/bit/objects
      - persist_to_workspace:
          root: .
          paths:
            - bit/.git/bit
            - bit/.bitmap
            - bit/workspace.jsonc
      - store_artifacts:
          path: ~/Library/Caches/Bit/logs
      - store_artifacts:
          path: bit/objects-before-export.tar

  harmony_publish_to_jfrog:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: print bit version
          command: npm view @teambit/bit version
      - run:
          name: Setup bit version environment variables
          command: echo "export BIT_VERSION=$(npm view @teambit/bit version)" >> $BASH_ENV && source $BASH_ENV
      - run:
          name: Install jFrog CLI
          command: curl -fL https://getcli.jfrog.io | sh
      - run:
          name: create empty folder
          command: mkdir bit-${BIT_VERSION}
      - run:
          name: install bit
          command: cd bit-${BIT_VERSION} && npm init -y && yarn add @teambit/bit
      - run:
          name: remove leftovers
          command: cd bit-${BIT_VERSION} && rm package.json && rm yarn.lock
      - run:
          name: compress bit
          command: tar -cvf bit-${BIT_VERSION}.tar.gz bit-${BIT_VERSION}
      - run:
          name: Configure jfrog auth
          command: ./jfrog rt config --url $jfrogUrl --user $jfrogUser --access-token $jfrogAcessToken --interactive=false
      - run:
          name: Upload tar file
          command: ./jfrog rt u "bit-${BIT_VERSION}.tar.gz" bvm/dev/${BIT_VERSION}/bit-${BIT_VERSION}.tar.gz --flat=false

  bundle_version_linux:
    <<: *defaults
    steps:
      - run:
          name: print bit version
          command: npm view @teambit/bit version
      - run:
          name: Setup bit version environment variables
          command: echo "export BIT_VERSION=$(npm view @teambit/bit version)" >> $BASH_ENV && source $BASH_ENV
      - run:
          name: create linux
          command: mkdir linux
      - run:
          name: create empty folder
          command: mkdir bit-${BIT_VERSION}
      - run:
          name: install bit
          command: cd bit-${BIT_VERSION} && npm init -y && yarn add @teambit/bit
      - run:
          name: remove leftovers
          command: cd bit-${BIT_VERSION} && rm package.json && rm yarn.lock
      - run:
          name: compress bit
          command: tar -cvf bit-${BIT_VERSION}.tar.gz bit-${BIT_VERSION}
      - run:
          name: move to linux folder
          command: mv bit-${BIT_VERSION}.tar.gz linux/bit-${BIT_VERSION}.tar.gz
      - persist_to_workspace:
          root: .
          paths:
            - linux
      - store_artifacts:
          path: linux

  bundle_version_macos:
    <<: *mac_defaults
    steps:
      - run: node -v
      - run: rm -rf /usr/local/bin/yarn
      - run: rm -rf /usr/local/bin/yarnpkg
      - run: npm install --global yarn --force
      - run: yarn cache clean
      - run: yarn -v
      - run:
          name: print bit version
          command: npm view @teambit/bit version
      - run:
          name: Setup bit version environment variables
          command: echo "export BIT_VERSION=$(npm view @teambit/bit version)" >> $BASH_ENV && source $BASH_ENV
      - run:
          name: create macos
          command: mkdir macos
      - run:
          name: create empty folder
          command: mkdir bit-${BIT_VERSION}
      - run:
          name: install bit
          command: cd bit-${BIT_VERSION} && npm init -y && yarn add @teambit/bit
      - run:
          name: remove leftovers
          command: cd bit-${BIT_VERSION} && rm package.json && rm yarn.lock
      - run:
          name: compress bit
          command: tar -cvf bit-${BIT_VERSION}.tar.gz bit-${BIT_VERSION}
      - run:
          name: move to macos folder
          command: mv bit-${BIT_VERSION}.tar.gz macos/bit-${BIT_VERSION}.tar.gz
      - persist_to_workspace:
          root: .
          paths:
            - macos
      - store_artifacts:
          path: macos

  bundle_version_windows:
    <<: *windows_defaults
    steps:
      - run: choco install nodejs --version 12.16.0
      # - run: nodejs.install v12.16.0
      - run: node -v
      - run: 'yarn -v'
      - run:
          name: print bit version
          command: npm view @teambit/bit version
      # - run:
      #     name: Setup bit version environment variables
      #     command: $BIT_VERSION = npm view @teambit/bit version
      # - run:
      #     name: print version again
      #     command: $BIT_VERSION
      - run:
          name: create version file
          command: npm view @teambit/bit version | Out-File -FilePath .\version.txt
      - run:
          name: create folder
          command: New-Item -ItemType "directory" -Path ".\bundle"
      # - run:
      #     name: create folder
      #     command: $BIT_VERSION = Get-Content -Path .\version.txt;New-Item -ItemType "directory" -Path ".\bit-$BIT_VERSION" -Force
      - run: 'node -v'
      - run:
          name: install bit
          command: cd bundle; npm init -y; yarn add @teambit/bit
      - run:
          name: remove leftovers
          command: Remove-Item .\bundle\package.json; Remove-Item .\bundle\yarn.lock
      - run:
          name: rename folder
          command: $BIT_VERSION = Get-Content -Path .\version.txt; Rename-Item .\bundle ".\bit-$BIT_VERSION"
      - run:
          name: compress bit
          command: $BIT_VERSION = Get-Content -Path .\version.txt; tar -cvf bit-${BIT_VERSION}.tar.gz bit-${BIT_VERSION}
      - run:
          name: create folder
          command: New-Item -ItemType "directory" -Path ".\windows"
      - run:
          name: move to windows folder
          command: $BIT_VERSION = Get-Content -Path .\version.txt;Move-Item -Path .\bit-${BIT_VERSION}.tar.gz -Destination .\windows\bit-${BIT_VERSION}.tar.gz
      - persist_to_workspace:
          root: .
          paths:
            - windows
      - store_artifacts:
          path: windows

  harmony_publish_to_gcloud:
    docker:
      - image: bitcli/node-gcloud-sdk
    <<: *defaults
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Setup bit version environment variables
          command: echo "export BIT_VERSION=$(npm view @teambit/bit version)" >> $BASH_ENV && source $BASH_ENV
      - run:
          name: Configure gcloud auth
          command: echo "${COMMAND_GCLOUD_AUTHENTICATE}" > /tmp/gcloud-service-key.json && gcloud auth activate-service-account --key-file=/tmp/gcloud-service-key.json
      - run:
          name: Upload tar file (Linux)
          command: gsutil cp linux/bit-${BIT_VERSION}.tar.gz gs://bvm.bit.dev/versions/dev/Linux/${BIT_VERSION}/bit-${BIT_VERSION}.tar.gz
      - run:
          name: Upload tar file (Windows)
          command: gsutil cp windows/bit-${BIT_VERSION}.tar.gz gs://bvm.bit.dev/versions/dev/Windows_NT/${BIT_VERSION}/bit-${BIT_VERSION}.tar.gz
      - run:
          name: Upload tar file (OSX)
          command: gsutil cp macos/bit-${BIT_VERSION}.tar.gz gs://bvm.bit.dev/versions/dev/Darwin/${BIT_VERSION}/bit-${BIT_VERSION}.tar.gz


  bit_export:
    <<: *defaults
    environment:
      # change the npm config to avoid using sudo
      NPM_CONFIG_PREFIX: ~/.npm-global
    steps:
      - attach_workspace:
          at: ./
      - bit_global_for_npm
      - bit_config:
          env: "hub"
      - restore_cache:
          key: bitsrc-ssh-key3
      - restore_cache:
          key: bitsrc-registry8
      - update_ssh_agent
      - set_git_credentials
      - run: bit config set user.token ${BIT_DEV_PROD_TOKEN}
      - run:
          name: export components
          command: cd bit && BIT_FEATURES=export-central bit export
          no_output_timeout: '20m'
      - run:
          name: backup bit objects (after export)
          command: cd bit && tar -zcvf objects-after-export.tar .git/bit/objects
      - run: cd bit && git commit -am "bump teambit version to `npm show @teambit/bit version` [skip ci]"
      # git pull first in case another commit entered to master so then the push could work with no errors.
      - run: cd bit && GIT_MERGE_AUTOEDIT=no git pull origin master
      # we use master here instead of ${CIRCLE_BRANCH} because we want to support running this from tag (manual nightly) as well
      - run: cd bit && git push origin master
      - store_artifacts:
          path: ~/Library/Caches/Bit/logs
      - store_artifacts:
          path: bit/objects-after-export.tar
      - store_artifacts:
          path: bit/.bitmap

  harmony_deploy_approval_job:
    <<: *defaults
    steps:
      - run: 'echo "starting harmony deploy"'

  e2e_test:
    <<: *defaults
    environment:
      # change the npm config to avoid using sudo
      NPM_CONFIG_PREFIX: ~/.npm-global
      BITSRC_ENV: stg
    parallelism: 25
    steps:
      - attach_workspace:
          at: ./
      # - run:
      #     # there are bugs in version 6.4.1 see https://github.com/teambit/bit/issues/1746
      #     name: 'update npm to latest version'
      #     command: 'npm i -g npm@latest'
      - bit_global_for_npm
      - bit_config
      - run:
          name: 'install expect lib (needed to add user for CI NPM registry, see npm-ci-registry.js)'
          command: 'sudo apt-get install expect'
      - restore_cache:
          key: bitsrc-ssh-key3
      - restore_cache:
          key: bitsrc-registry8
      # add the id_rsa to ssh_agent to make sure we authenticate with the correct user
      # - run: 'chmod 400 ~/.ssh/id_rsa'
      # - run: 'ssh-add ~/.ssh/id_rsa'
      - run: 'cd bit && mkdir junit'
      - run: 'bit config set package-manager.cache /home/circleci/package-manager-cache'
      # Make sure when we run bit from e2e tests we run it from the global not from here
      - run: 'rm bit/node_modules/.bin/bit'
      - run:
          name: 'Run e2e tests'
          command: 'cd bit && circleci tests glob "e2e/**/*.e2e*.ts" | circleci tests split --split-by=filesize | xargs -n 1 npm run mocha-circleci'
          # command which support only - for debug purpose
          # command: cd bit && npm run e2e-test-circle --debug
          environment:
            MOCHA_FILE: junit/e2e-test-results.xml
          when: always
      - store_test_results:
          path: bit/junit
      - store_artifacts:
          path: bit/junit
      - store_artifacts:
          path: ~/Library/Caches/Bit/logs

  performance_e2e_test:
    <<: *defaults
    resource_class: medium
    environment:
      # change the npm config to avoid using sudo
      NPM_CONFIG_PREFIX: ~/.npm-global
      BITSRC_ENV: stg
      # NPM_CONFIG_DEBUG: true
    parallelism: 1
    steps:
      - attach_workspace:
          at: ./
      - run: 'cd bit && mkdir junit'
      - bit_global_for_npm
      - bit_config
      - run:
          name: 'Run performance tests'
          command: 'cd bit && npm run performance-test-circle'
          environment:
            MOCHA_FILE: junit/e2e-test-results.xml
          when: always
          no_output_timeout: '25m'
      - store_test_results:
          path: bit/junit
      - store_artifacts:
          path: bit/junit
      - store_artifacts:
          path: ~/Library/Caches/Bit/logs/debug.log

  bit_hub_e2e_test:
    <<: *defaults
    resource_class: medium
    environment:
      # change the npm config to avoid using sudo
      NPM_CONFIG_PREFIX: ~/.npm-global
      BITSRC_ENV: stg
      # NPM_CONFIG_DEBUG: true
    parallelism: 1
    steps:
      - attach_workspace:
          at: ./
      - run: 'sudo npm i -g yarn'
      - run:
          # there are bugs in version 6.4.1 see https://github.com/teambit/bit/issues/1746
          name: 'update npm to latest version'
          command: 'npm i -g npm@latest'
      - run:
          name: 'save SHA to a file'
          command: 'echo $CIRCLE_SHA1 > .circle-sha'
      - restore_cache:
          key: bitsrc-ssh-key3
      - restore_cache:
          key: bitsrc-registry8
          # key: bitsrc-registry-stg-v2
      - # add the id_rsa to ssh_agent to make sure we authenticate with the correct user
        run: 'chmod 400 ~/.ssh/id_rsa'
      - run: 'ssh-add ~/.ssh/id_rsa'
      - run: 'cd bit && mkdir junit'
      - bit_global_for_npm
      - bit_config
      - run:
          name: 'Run bit-hub tests'
          command: 'cd bit && npm run bit-hub-test-circle'
          environment:
            MOCHA_FILE: junit/e2e-test-results.xml
          when: always
      - store_test_results:
          path: bit/junit
      - store_artifacts:
          path: bit/junit

  windows_approval_job:
    <<: *windows_defaults
    steps:
      - run: 'echo "starting windows build"'

  windows_checkout_code:
    <<: *windows_defaults
    steps:
      # - checkout
      - run: git clone https://github.com/teambit/bit.git
      - persist_to_workspace:
          root: C:\Users\circleci\project
          paths:
            - bit

  # TODO: make it powershell if you want to use it
  windows_set_ssh_key:
    <<: *windows_defaults
    working_directory: C:\Users\circleci\.ssh
    steps:
      - run: 'echo "-----BEGIN RSA PRIVATE KEY-----" >> id_rsa'
      - run: 'echo ${testerBitsrcSSHPrivateKey} >> id_rsa'
      - run: 'echo "-----END RSA PRIVATE KEY-----" >> id_rsa'
      - run: 'echo ${testerBitsrcSSHPublicKey} >> id_rsa.pub'
      - save_cache:
          key: windows_bitsrc-ssh-key-v1
          paths:
            - id_rsa
            - id_rsa.pub

  windows_set_npm_registries:
    <<: *windows_defaults
    steps:
      # npmjs regisry
      - run:
          name: setting npmjs regisry
          command: Add-Content C:\Users\circleci\.npmrc ("//registry.npmjs.org/:_authToken=" + $Env:npmjsRegistryToken)
      # prod registry
      # -
      # run: npm config set @bit:registry https://node.bit.dev
      - run: Add-Content -Path C:\Users\circleci\.npmrc  -Value '@bit:registry=https://node.bit.dev'
      # -
      #   run: Get-Content -Path C:\Users\circleci\.npmrc
      # -
      #   run: Add-Content -Path C:\Users\circleci\.npmrc  -Value '//node.bit.dev/:_authToken=$Env:registryProdToken'
      - run:
          name: setting bit registry
          command: Add-Content C:\Users\circleci\.npmrc ("//node.bit.dev/:_authToken=" + $Env:registryProdToken)
      # stage registry
      # -
      #   run: Add-Content -Path C:\Users\circleci\.npmrc  -Value '@bit:registry=https://node-stg.bit.dev'
      # -
      #   run:
      #     name: setting bit registry
      #     command: Add-Content C:\Users\circleci\.npmrc ("//node-stg.bit.dev/:_authToken=" + $Env:registryStgToken)
      # -
      #   run: Add-Content -Path C:\Users\circleci\.npmrc  -Value '//node.bit.dev/:_authToken=$Env:registryStgToken'
      - save_cache:
          key: windows_bitsrc-registry-v5
          # key: windows_bitsrc-registry-stg-v2
          paths:
            - C:\Users\circleci\.npmrc

  windows_install_npm_deps:
    <<: *windows_defaults
    # skipping the pre-built binaries to make sure we build them by the pack step
    # testing the install script will be done in different workflow dedicated for this
    environment:
      SKIP_FETCH_BINARY: true
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          key: windows_bitsrc-registry-v5
          # key: windows_bitsrc-registry-stg-v2
      # -
      #   run: 'npm config list'
      - run:
          name: 'Install npm dependencies'
          command: 'cd bit; npm install'
      - persist_to_workspace:
          root: .
          paths:
            - bit/node_modules

  windows_build:
    <<: *windows_defaults
    steps:
      - attach_workspace:
          at: .
      - run:
          name: 'Build bit source code'
          command: 'cd bit; npm run build'
      - persist_to_workspace:
          root: .
          paths:
            - bit/dist

  windows_bvm_install:
    <<: *windows_defaults
    environment:
      Path: C:\Users\circleci\.npm-global;C:\Users\circleci\AppData\Local\.bvm;$ENV:PATH
    steps:
      - attach_workspace:
          at: .
      - run: npm view @teambit/bit version | Out-File -FilePath .\version.txt
      - run: Get-Content -Path .\version.txt
      - restore_cache:
          key: v1-bvm-folder-{{ checksum "version.txt" }}
      - run: 'npm i -g @teambit/bvm'
      - run: 'bvm upgrade'
      - run: 'setx path "%path%;C:\Users\circleci\AppData\Local\.bvm"'
      - run: 'bit -v'
      - run: bit -v | Out-File -FilePath .\version.txt
      - run: Get-Content -Path .\version.txt
      - save_cache:
          key: v1-bvm-folder-{{ checksum "version.txt" }}
          paths:
            - C:\Users\circleci\AppData\Local\.bvm
      - persist_to_workspace:
          root: .
          paths:
            - version.txt

  windows_build_bvm:
    <<: *windows_defaults
    environment:
      BITSRC_ENV: stg
      SKIP_REGISTRY_TESTS: true
      SKIP_BIT_DEV_TESTS: true
    parallelism: 1
    steps:
      - attach_workspace:
          at: .
      - run: cinst nodejs --version 12.15.0
      - run: node -v
      - run: npm -v
      # - run: Get-Content -Path .\version.txt
      # - restore_cache:
      #     key: bvm-folder-v1
      - restore_cache:
          key: v1-bvm-folder-{{ checksum "version.txt" }}
      # - run: bit -v
      - run: 'setx path "%path%;C:\Users\circleci\AppData\Local\.bvm"'
      - run: bit -v
      # - run: 'npm i -g @teambit/bvm'
      # - run: 'bvm list'
      # - run: 'bvm link'
      # - run: bit -v
      - run:
          name: 'save SHA to a file'
          command: 'echo $CIRCLE_SHA1 > .circle-sha'
      - restore_cache:
          key: windows_bitsrc-ssh-key-v1
      - restore_cache:
          key: windows_bitsrc-registry-v1
          # key: windows_bitsrc-registry-stg-v2
      # -
      #   restore_cache:
      #     keys:
      #       - 'builded-{{ checksum ".circle-sha" }}'
      # -
      # add the id_rsa to ssh_agent to make sure we authenticate with the correct user
      #   run: 'chmod 400 ~/.ssh/id_rsa'
      # -
      #   run: 'ssh-add ~/.ssh/id_rsa'
      - bit_config:
          token: "fake-token"
      - run: 'pwd'
      - run: 'ls'
      - run: 'ls bit\bit'
      - run: 'cd bit\bit; bit install'
      - run: 'cd bit\bit; bit compile'
      - run: 'cd bit\bit; npm run build'
      - persist_to_workspace:
          root: .
          paths:
            - bit
  windows_e2e_test_bvm:
    <<: *windows_defaults
    environment:
      BITSRC_ENV: stg
      SKIP_REGISTRY_TESTS: true
      SKIP_BIT_DEV_TESTS: true
    parallelism: 25
    steps:
      - attach_workspace:
          at: .
      - run: cinst nodejs --version 12.15.0
      - run: node -v
      - run: npm -v
      # - run: Get-Content -Path .\version.txt
      # - restore_cache:
      #     key: bvm-folder-v1
      - restore_cache:
          key: v1-bvm-folder-{{ checksum "version.txt" }}
      # - run: bit -v
      - run: 'setx path "%path%;C:\Users\circleci\AppData\Local\.bvm"'
      - run: bit -v
      # - run: 'npm i -g @teambit/bvm'
      # - run: 'bvm list'
      # - run: 'bvm link'
      # - run: bit -v
      - run:
          name: 'save SHA to a file'
          command: 'echo $CIRCLE_SHA1 > .circle-sha'
      - restore_cache:
          key: windows_bitsrc-ssh-key-v1
      - restore_cache:
          key: windows_bitsrc-registry-v1
          # key: windows_bitsrc-registry-stg-v2
      # -
      #   restore_cache:
      #     keys:
      #       - 'builded-{{ checksum ".circle-sha" }}'
      # -
      # add the id_rsa to ssh_agent to make sure we authenticate with the correct user
      #   run: 'chmod 400 ~/.ssh/id_rsa'
      # -
      #   run: 'ssh-add ~/.ssh/id_rsa'
      - run: 'cd bit\bit; mkdir junit'
      - bit_config:
          token: "fake-token"
      - run:
          name: 'write e2e files'
          command: 'cd bit\bit; circleci tests glob "e2e\*\*.e2e*.ts" | circleci tests split --split-by=filesize | Out-File -FilePath .\spec-files.txt'
      - run: Get-Content -Path .\bit\bit\spec-files.txt
      - run: 'cd bit\bit; cmd /c rmdir /s /q .\node_modules\@teambit\legacy; New-Item -Path node_modules\@teambit\legacy -ItemType SymbolicLink -Value .'
      - run:
          name: 'run e2e tests'
          command: 'cd bit\bit; $content = get-content spec-files.txt; npm run mocha-circleci $content'
          # command which support only - for debug purpose - this needed to be tested on windows (the glob might not work)
          # command: cd bit; npm run e2e-test-circle --debug
          environment:
            MOCHA_FILE: junit\e2e-test-results.xml
          when: always
      - store_test_results:
          path: bit\junit
      - store_artifacts:
          path: bit\junit
      -
        store_artifacts:
          path: C:\Users\circleci\AppData\Local\Bit\logs\debug.log
  windows_e2e_test:
    <<: *windows_defaults
    environment:
      BITSRC_ENV: stg
      SKIP_REGISTRY_TESTS: true
      SKIP_BIT_DEV_TESTS: true
    parallelism: 25
    steps:
      - attach_workspace:
          at: .
      - run: $Env:Path
      - run: 'npm i -g yarn'
      - run: 'npm -v'
      # -
      #   run:
      #     # there are bugs in version 6.4.1 see https://github.com/teambit/bit/issues/1746
      #     name: 'update npm to latest version'
      #     command: 'npm i -g npm@latest'
      #
      # this might be required if you try to update npm version
      # - run: setx path "C:\Users\circleci\.npm-global"
      - run:
          name: 'save SHA to a file'
          command: 'echo $CIRCLE_SHA1 > .circle-sha'
      - restore_cache:
          key: windows_bitsrc-ssh-key-v1
      - restore_cache:
          key: windows_bitsrc-registry-v1
          # key: windows_bitsrc-registry-stg-v2
      # -
      #   restore_cache:
      #     keys:
      #       - 'builded-{{ checksum ".circle-sha" }}'
      # -
      # add the id_rsa to ssh_agent to make sure we authenticate with the correct user
      #   run: 'chmod 400 ~/.ssh/id_rsa'
      # -
      #   run: 'ssh-add ~/.ssh/id_rsa'
      - run: 'cd bit; mkdir junit'
      - run:
          name: 'npm link bit to global'
          command: cd bit; npm link
      - bit_config
      - run:
          name: 'write e2e files'
          command: 'cd bit; circleci tests glob "e2e\*\*.e2e*.ts" | circleci tests split --split-by=timings > spec-files.txt'
      - run:
          name: 'run e2e tests'
          command: 'cd bit; $content = get-content spec-files.txt; npm run mocha-circleci $content'
          # command which support only - for debug purpose - this needed to be tested on windows (the glob might not work)
          # command: cd bit; npm run e2e-test-circle --debug
          environment:
            MOCHA_FILE: junit\e2e-test-results.xml
          when: always
      - store_test_results:
          path: bit\junit
      - store_artifacts:
          path: bit\junit
      # TODO: make it work for windows
      # -
      #   store_artifacts:
      #     path: ~/Library/Caches/Bit/logs/debug.log

workflows:
  version: 2
  build_and_test:
    jobs:
      - checkout_code
      - set_ssh_key
      - set_npm_registries
      - setup_harmony:
          requires:
            - set_npm_registries
            - checkout_code
      - unit_test:
          requires:
            - setup_harmony
      - lint:
          requires:
            - setup_harmony
      - generate_and_check_types:
          requires:
            - setup_harmony
      - generate_docs:
          <<: *semver_tags_only_filters
          requires:
            - setup_harmony
      - e2e_test:
          requires:
            - setup_harmony
      - bit_build:
          requires:
            - generate_and_check_types

  # windows_e2e:
  #   jobs:
  #     - windows_approval_job:
  #         type: approval
  #     - windows_checkout_code:
  #         requires:
  #           - windows_approval_job
  #     # - windows_set_ssh_key:
  #     #     requires:
  #     #       - windows_approval_job
  #     - windows_set_npm_registries:
  #         requires:
  #           - windows_approval_job
  #     - windows_install_npm_deps:
  #         requires:
  #           - windows_checkout_code
  #           - windows_set_npm_registries
  #     - windows_build:
  #         requires:
  #           - windows_install_npm_deps
  #     - windows_e2e_test:
  #         requires:
  #           - windows_build
  #           # - windows_set_ssh_key
  #           - windows_set_npm_registries

  deploy:
    jobs:
      - checkout_code:
          <<: *semver_tags_only_filters
      - validate-git-tag-and-version:
          <<: *semver_tags_only_filters
          requires:
            - checkout_code
      #-
      # install_npm_deps:
      #   <<: *semver_tags_only_filters
      #   requires:
      #     - validate-git-tag-and-version
      #     - checkout_code
      - build:
          <<: *semver_tags_only_filters
        #  requires:
        #    - setup_harmony
      - npm-publish:
          <<: *semver_tags_only_filters
          requires:
            - build
      - generate_docs:
          <<: *semver_tags_only_filters
          requires:
            - build
      - pack:
          <<: *semver_tags_only_filters
          requires:
            - build
      - github-release:
          <<: *semver_tags_only_filters
          requires:
            - pack
      - build-rpm:
          <<: *semver_tags_only_filters
          requires:
            - pack
      - build-debian:
          <<: *semver_tags_only_filters
          requires:
            - pack
      - publish_to_jfrog:
          <<: *semver_tags_only_filters
          requires:
            - build-debian
            - build-rpm
      - slack_deploy_notification:
          <<: *semver_tags_only_filters
          requires:
            - generate_docs
            - publish_to_jfrog
            - github-release
            - npm-publish

  deploy_dev:
    jobs:
      - checkout_code:
          <<: *dev_tag_only_filters
      #-
      # install_npm_deps:
      #   <<: *dev_tag_only_filters
      #   requires:
      #     - checkout_code
      - build:
          <<: *dev_tag_only_filters
        #  requires:
        #    - setup_harmony
      - pack:
          <<: *dev_tag_only_filters
          requires:
            - build
      - github-pre-release:
          <<: *dev_tag_only_filters
          requires:
            - pack
      - build-rpm:
          <<: *dev_tag_only_filters
          requires:
            - pack
      - build-debian:
          <<: *dev_tag_only_filters
          requires:
            - pack
      - publish_to_jfrog_dev:
          <<: *dev_tag_only_filters
          requires:
            - build-debian
            - build-rpm

  performance_tests:
    triggers:
      - schedule:
          cron: '0 9 * * *'
          filters:
            branches:
              only:
                - prod
    jobs:
      - checkout_code
      - set_npm_registries
      #-
      # install_npm_deps:
      #   requires:
      #     - checkout_code
      #     - set_npm_registries
      - build
        #  requires:
        #    - setup_harmony
      - performance_e2e_test:
          requires:
            - build

  bit_hub_tests:
    triggers:
      - schedule:
          cron: '0 10 * * *'
          filters:
            branches:
              only:
                - prod
    jobs:
      - checkout_code
      - set_ssh_key
      - set_npm_registries
      #-
      #  install_npm_deps:
      #    requires:
      #      - checkout_code
      #      - set_npm_registries
      - build
      #    requires:
      #      - setup_harmony
      - bit_hub_e2e_test:
          requires:
            - set_ssh_key
            - set_npm_registries
            - build

  nightly:
    triggers:
      - schedule: # every day at 3AM UTC (= 11PM EST = 6AM IST)
          cron: '0 3 * * *'
          filters:
            branches:
              only:
                - master
    jobs:
      - checkout_code
      - set_ssh_key
      - set_npm_registries
      - setup_harmony:
          requires:
            - set_npm_registries
            - checkout_code
      - bit_tag:
          <<: *master_only_filter
          requires:
            - setup_harmony
      - bundle_version_linux:
          <<: *master_only_filter
          requires:
            - bit_tag
      - bundle_version_windows:
          <<: *master_only_filter
          requires:
            - bit_tag
      - bundle_version_macos:
          <<: *master_only_filter
          requires:
            - bit_tag
      - harmony_publish_to_gcloud:
          <<: *master_only_filter
          requires:
            - bundle_version_linux
            - bundle_version_windows
            - bundle_version_macos
      - bit_export:
          <<: *master_only_filter
          requires:
            - bit_tag
      - docker_build:
          requires:
            - bit_tag

  windows-nightly:
    triggers:
      - schedule: # every day at 5AM UTC (= 1AM EST = 8AM IST)
          cron: '0 5 * * *'
          filters:
            branches:
              only:
                - master
    jobs:
      - windows_checkout_code
      - windows_set_ssh_key
      - windows_bvm_install:
          <<: *master_only_filter
          requires:
            - windows_checkout_code
      - windows_build_bvm:
          <<: *master_only_filter
          requires:
            - windows_bvm_install
      - windows_e2e_test_bvm:
          <<: *master_only_filter
          requires:
            - windows_checkout_code
            - windows_set_ssh_key
            - windows_bvm_install
            - windows_build_bvm

  # Uncomment in cse you want to run the windows tests
  # build_and_test_windows:
  #   jobs:
  #     - windows_set_ssh_key
  #     - windows_checkout_code
  #     - windows_bvm_install:
  #         requires:
  #           - windows_checkout_code
  #     - windows_build_bvm:
  #         requires:
  #           - windows_bvm_install
  #     - windows_e2e_test_bvm:
  #         requires:
  #           - windows_checkout_code
  #           - windows_set_ssh_key
  #           - windows_bvm_install
  #           - windows_build_bvm

  # TODO: check if we can combine it with the regular nightly somehow
  harmony_deploy:
    jobs:
      - harmony_deploy_approval_job:
          <<: *master_only_filter
          type: approval
      - checkout_code:
          <<: *master_only_filter
          requires:
            - harmony_deploy_approval_job
      - set_ssh_key:
          <<: *master_only_filter
          requires:
            - harmony_deploy_approval_job
      - set_npm_registries:
          <<: *master_only_filter
          requires:
            - harmony_deploy_approval_job
      - setup_harmony:
          <<: *master_only_filter
          requires:
            - harmony_deploy_approval_job
            - set_npm_registries
            - checkout_code
      - bit_tag:
          <<: *master_only_filter
          requires:
            - harmony_deploy_approval_job
            - setup_harmony
      - bundle_version_linux:
          <<: *master_only_filter
          requires:
            - harmony_deploy_approval_job
            - bit_tag
      - bundle_version_windows:
          <<: *master_only_filter
          requires:
            - harmony_deploy_approval_job
            - bit_tag
      - bundle_version_macos:
          <<: *master_only_filter
          requires:
            - harmony_deploy_approval_job
            - bit_tag
      - harmony_publish_to_gcloud:
          <<: *master_only_filter
          requires:
            - harmony_deploy_approval_job
            - bundle_version_linux
            - bundle_version_windows
            - bundle_version_macos
      - bit_export:
          <<: *master_only_filter
          requires:
            - bit_tag
            - harmony_deploy_approval_job
      - docker_build:
          <<: *master_only_filter
          requires:
            - harmony_deploy_approval_job
            - bit_tag
