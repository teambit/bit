version: 2
jobs:
  checkout_code:
    docker:
      - image: circleci/node:6.10.3
    working_directory: ~/bit
    steps:
      - checkout

  set-ssh-key:
    docker:
        - image: circleci/node:6.10.3
    working_directory: ~/.ssh
    steps:
      - run: "echo \"-----BEGIN RSA PRIVATE KEY-----\" >> ~/.ssh/id_rsa"
      - run: echo ${bithubKey} >> ~/.ssh/id_rsa
      - run: "echo \"-----END RSA PRIVATE KEY-----\" >> ~/.ssh/id_rsa"

  build:
     docker:
       - image: circleci/node:6.10.3
     working_directory: ~/bit
     steps:
      - run:
          name: Insatll npm dependencies
          command: 'npm install'
      - run: 
          name: Build bit source code
          command: npm run build
   
  global-install:
    docker:
      - image: circleci/node:6.10.3
    working_directory: ~/bit
    steps:
      - run:
          name: Insatll bit globaly
          command: 'npm install -g'
    
  unit-test:
    docker:
      - image: circleci/node:6.10.3
    working_directory: ~/bit
    steps:
      - run: mkdir ~/junit
      - run: 
          command: npm run test-circle
          environment:
            MOCHA_FILE: junit/unit-test-results.xml
          when: always
      - store_test_results:
          path: ~/junit
      - store_artifacts:
          path: ~/junit
  
  e2e-test:
    docker:
      - image: circleci/node:6.10.3
    working_directory: ~/bit
    steps:
      - run: mkdir ~/junit
      - run: 
          command: npm run e2e-test-circle
          environment:
            MOCHA_FILE: junit/e2e-test-results.xml
          when: always
      - store_test_results:
          path: ~/junit
      - store_artifacts:
          path: ~/junit

workflows:
  version: 2
  build-and-test:
    jobs:
      - checkout_code
      - build:
          requires:
            - checkout_code
      - unit-test:
          requires:
            - build
      - global-install:
          requires:
            - build
      - e2e-test:
          requires:
            - global-install
            - set-ssh-key