#!/usr/bin/env bash
#
# bit-cli-lookup - Query Bit CLI command reference
# Usage: bit-cli-lookup <command-name>
#        bit-cli-lookup --list
#        bit-cli-lookup --update
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLI_REF="$SCRIPT_DIR/cli-reference.json"
CLI_REF_URL="https://raw.githubusercontent.com/teambit/bit/master/scopes/harmony/cli-reference/cli-reference.json"

# Colors (disabled if not a terminal)
if [ -t 1 ]; then
    BOLD='\033[1m'
    DIM='\033[2m'
    CYAN='\033[36m'
    GREEN='\033[32m'
    YELLOW='\033[33m'
    RESET='\033[0m'
else
    BOLD='' DIM='' CYAN='' GREEN='' YELLOW='' RESET=''
fi

usage() {
    echo "Usage: bit-cli-lookup <command-name>"
    echo "       bit-cli-lookup --list      List all commands"
    echo "       bit-cli-lookup --update    Update CLI reference from GitHub"
    echo ""
    echo "Examples:"
    echo "  bit-cli-lookup snap"
    echo "  bit-cli-lookup tag"
    echo "  bit-cli-lookup lane"
    exit 1
}

check_jq() {
    if ! command -v jq &> /dev/null; then
        echo "Error: jq is required but not installed."
        echo "Install with: brew install jq (macOS) or apt-get install jq (Linux)"
        exit 1
    fi
}

check_cli_ref() {
    if [ ! -f "$CLI_REF" ]; then
        echo "CLI reference not found. Downloading..."
        update_cli_ref
    fi
}

update_cli_ref() {
    echo "Updating CLI reference from GitHub..."
    if curl -sL "$CLI_REF_URL" -o "$CLI_REF.tmp"; then
        mv "$CLI_REF.tmp" "$CLI_REF"
        echo "Updated successfully."
    else
        echo "Error: Failed to download CLI reference."
        rm -f "$CLI_REF.tmp"
        exit 1
    fi
}

list_commands() {
    echo -e "${BOLD}Available Bit Commands:${RESET}\n"
    jq -r '
        .[] |
        select(.private != true) |
        "  \(.name)\(.alias | if . != "" then " (alias: \(.))" else "" end)"
    ' "$CLI_REF" | sort
}

format_command() {
    jq -r --arg cmd "$1" '
        def format_cmd:
            . as $c |
            "\n\u001b[1m\u001b[36mCommand: bit \(.name)\u001b[0m" +
            (if .alias != "" then "\n\u001b[2mAlias: \(.alias)\u001b[0m" else "" end) +
            "\n\n\(.description)" +
            (if .extendedDescription != "" then "\n\n\(.extendedDescription)" else "" end) +

            # Arguments
            (if (.arguments // []) | length > 0 then
                "\n\n\u001b[1mArguments:\u001b[0m\n" +
                ([.arguments[] | "  \(.name): \(.description // "")"] | join("\n"))
            else "" end) +

            # Options
            (if (.options // []) | length > 0 then
                "\n\n\u001b[1mOptions:\u001b[0m\n" +
                ([.options[] |
                    "  " +
                    (if .[0] != "" then "-\(.[0]), " else "    " end) +
                    "--\(.[1])" +
                    (if .[2] != "" then "\n      \(.[2])" else "" end)
                ] | join("\n"))
            else "" end) +

            # Examples
            (if (.examples // []) | length > 0 then
                "\n\n\u001b[1mExamples:\u001b[0m\n" +
                ([.examples[] | "  bit \(.cmd)\n      \(.description)"] | join("\n"))
            else "" end) +

            # Subcommands
            (if (.commands // []) | length > 0 then
                "\n\n\u001b[1mSubcommands:\u001b[0m\n" +
                ([.commands[] | "  \(.name): \(.description)"] | join("\n"))
            else "" end);

        # Search for matching commands (main commands and subcommands)
        [
            # Match main commands
            (.[] | select(
                (.name | ascii_downcase | split(" ")[0]) == ($cmd | ascii_downcase) or
                (.name | ascii_downcase | startswith($cmd | ascii_downcase)) or
                (.alias | ascii_downcase) == ($cmd | ascii_downcase)
            )),
            # Match subcommands
            (.[] | .commands // [] | .[] | select(
                (.name | ascii_downcase) == ($cmd | ascii_downcase) or
                (.name | ascii_downcase | startswith($cmd | ascii_downcase))
            ))
        ] |
        if length == 0 then
            "No command found matching: \($cmd)\n\nTry: bit-cli-lookup --list"
        else
            .[] | format_cmd
        end
    ' "$CLI_REF"
}

# Main
check_jq

case "${1:-}" in
    "")
        usage
        ;;
    --help|-h)
        usage
        ;;
    --list|-l)
        check_cli_ref
        list_commands
        ;;
    --update|-u)
        update_cli_ref
        ;;
    *)
        check_cli_ref
        format_command "$1"
        ;;
esac
