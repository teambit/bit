version: 1.0.{build}
image: Visual Studio 2015

skip_branch_with_pr: true

# build cache to preserve files/folders between builds
cache:
  - node_modules                    # local npm modules
  - '%APPDATA%\npm-cache'           # npm cache

environment:
  priv_key:
    secure: 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`
  token:
    secure: 0a4USjGKxWeE8xz4tO5MnQ==
  releaseUser:
    secure: 0a4USjGKxWeE8xz4tO5MnQ==
  releasePassword:
    secure: tR01IIjMw35fBOFhTQd9jw==
  repoUser:
    secure: B5rIxIs4O8RRe0ml9e87+A==
  repoPassword:
    secure: tR01IIjMw35fBOFhTQd9jw==
  ruby_version:
    secure: k41GeNhYWLfPG/Fir8TGhA==
  ENVIRONMENT:
    secure: 0MX/69qK7Z1yjELPC8wOCw==
  ReleaseServerDevelopment:
    secure: UHrmNjH6IaU79OhRU9ina1f5jPX1EXBlsm9w+QfqWA/jNLPx4t+XMottVjJHZVtr
  ReleaseServerStable:
    secure: y7mz8E9mkcwCaCVvFs9WX+5k8jg+t8HwFpZhMYlYEfZhdnFH1U7gWCJTi+zVLiT9
  matrix:
  - ruby_version: Ruby23-x64
install:
  - ps: $fileContent = "-----BEGIN RSA PRIVATE KEY-----`n"
  - ps: $fileContent += $env:priv_key.Replace(' ', "`n")
  - ps: $fileContent += "`n-----END RSA PRIVATE KEY-----`n"
  - ps: Set-Content c:\users\appveyor\.ssh\id_rsa $fileContent
  - ps: Install-Product node 6
  - "npm i"
  - "npm run build"
  - "npm install -g"
  - "bit config set ssh_key_file c:\\users\\appveyor\\.ssh\\id_rsa"
  - ps: $ENV:PATH="C:\Ruby200-x64\bin;C:\Python27-x64;$ENV:PATH"

build_script:
- ps: >-
    mv .\package.json .\package.json.bak

    Get-Content .\package.json.bak | Where-Object {$_ -notmatch 'posix'} | Where-Object {$_ -notmatch 'gitbook-cli'} | Set-Content package.json


test_script:
  - npm run test:appveyor
  - npm run e2e-test:appveyor

after_test:
- ps: >-
    .\scripts\node-installer.ps1

    .\scripts\build-dist.ps1

    .\scripts\build-windows-installer.bat

    .\scripts\copyArtifacts.ps1

artifacts:
- path: artifacts\*.msi
  name: Installer
- path: artifacts\bit.${VERSION}.nupkg
  name: nupkg
deploy_script:
- ps: >-
    $VERSION= $(node -p -e "require('./package.json').version")

    .\scripts\deploy-windows.ps1 -Repo bit-msi -File bit-${VERSION}-unsigned.msi -Source artifacts\bit-${VERSION}-unsigned.msi -ENVIRONMENT development -ReleaseServer $env:ReleaseServerDevelopment -Method msi

    .\scripts\build-chocolatey.ps1

    .\scripts\deploy-windows.ps1 -Repo bit-nuget -File bit.${VERSION}.nupkg -Source artifacts\bit.${VERSION}.nupkg -ENVIRONMENT development -ReleaseServer $env:ReleaseServerDevelopment -Method nupkg

