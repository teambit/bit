version: 1.0.{build}
image: Visual Studio 2015

skip_branch_with_pr: true

# build cache to preserve files/folders between builds
cache:
  - node_modules                    # local npm modules
  - '%APPDATA%\npm-cache'           # npm cache

environment:
  priv_key:
    secure: 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
  token:
    secure: 0a4USjGKxWeE8xz4tO5MnQ==
  releaseUser:
    secure: 0a4USjGKxWeE8xz4tO5MnQ==
  releasePassword:
    secure: tR01IIjMw35fBOFhTQd9jw==
  repoUser:
    secure: B5rIxIs4O8RRe0ml9e87+A==
  repoPassword:
    secure: tR01IIjMw35fBOFhTQd9jw==
  ruby_version:
    secure: k41GeNhYWLfPG/Fir8TGhA==
  ENVIRONMENT:
    secure: 0MX/69qK7Z1yjELPC8wOCw==
  ReleaseServerDevelopment:
    secure: UHrmNjH6IaU79OhRU9ina1f5jPX1EXBlsm9w+QfqWA/jNLPx4t+XMottVjJHZVtr
  ReleaseServerStable:
    secure: y7mz8E9mkcwCaCVvFs9WX+5k8jg+t8HwFpZhMYlYEfZhdnFH1U7gWCJTi+zVLiT9
  matrix:
  - ruby_version: Ruby23-x64
install:
  - ps: $fileContent = "-----BEGIN RSA PRIVATE KEY-----`n"
  - ps: $fileContent += $env:priv_key.Replace(' ', "`n")
  - ps: $fileContent += "`n-----END RSA PRIVATE KEY-----`n"
  - ps: Set-Content c:\users\appveyor\.ssh\id_rsa $fileContent
  - ps: Install-Product node 6
  - ps: $ENV:PATH="C:\Ruby200-x64\bin;C:\Python27-x64;$ENV:PATH"

build_script:
- ps: >-
    mv .\package.json .\package.json.bak

    Get-Content .\package.json.bak | Where-Object {$_ -notmatch 'posix'} | Where-Object {$_ -notmatch 'gitbook-cli'} | Set-Content package.json


test_script:
  - ECHO "assas"

after_test:
- ps: >-
    mkdir artifacts
    .\scripts\node-installer.ps1

    .\scripts\build-dist.ps1

    .\scripts\build-windows-installer.bat
- ps: dir distribution\
- ps: $VERSION= $(node -p -e "require('./package.json').version")
- ps: mv distribution\windows\distribution\winMsibin\Release\Bit.msi  ..\..\artifacts\bit-$VERSION-unsigned.msi

artifacts:
- path: distribution/windows/artifacts/*.msi
  name: Installer
- path: artifacts\bit.${VERSION}.nupkg
  name: nupkg
deploy_script:
- ps: >-
    $VERSION= $(node -p -e "require('./package.json').version")

    .\scripts\deploy-windows.ps1 -Repo bit-msi -File bit-${VERSION}-unsigned.msi -Source artifacts\bit-${VERSION}-unsigned.msi -ENVIRONMENT development -ReleaseServer $env:ReleaseServerDevelopment -Method msi

    .\scripts\build-chocolatey.ps1

    .\scripts\deploy-windows.ps1 -Repo bit-nuget -File bit.${VERSION}.nupkg -Source artifacts\bit.${VERSION}.nupkg -ENVIRONMENT development -ReleaseServer $env:ReleaseServerDevelopment -Method nupkg

