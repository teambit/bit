version: 1.0.{build}
image: Visual Studio 2015

branches:
  only:
    - master
    - windowsNode

environment:
  token:
    secure: 0a4USjGKxWeE8xz4tO5MnQ==
  releaseUser:
    secure: 0a4USjGKxWeE8xz4tO5MnQ==
  releasePassword:
    secure: tR01IIjMw35fBOFhTQd9jw==
  repoUser:
    secure: B5rIxIs4O8RRe0ml9e87+A==
  repoPassword:
    secure: tR01IIjMw35fBOFhTQd9jw==
  ruby_version:
    secure: k41GeNhYWLfPG/Fir8TGhA==
  ENVIRONMENT:
    secure: 0MX/69qK7Z1yjELPC8wOCw==
  ReleaseServerDevelopment:
    secure: UHrmNjH6IaU79OhRU9ina1f5jPX1EXBlsm9w+QfqWA/jNLPx4t+XMottVjJHZVtr
  ReleaseServerStable:
    secure: y7mz8E9mkcwCaCVvFs9WX+5k8jg+t8HwFpZhMYlYEfZhdnFH1U7gWCJTi+zVLiT9
  matrix:
  - ruby_version: Ruby23-x64
  nodejs_version: "6"

install:
- ps: $key = $env:gitkey #just the key contents, copied from notepad, into the environment variable on the UI
- ps: $fileContent = "-----BEGIN RSA PRIVATE KEY-----" + "`n"
- ps: for ($i = 0; $i -lt $key.Length / 64; $i++) { $min = [math]::min(64, $key.Length - ($i * 64)); $fileContent += $key.substring($i*64, $min) + "`n"; }
- ps: $fileContent += "-----END RSA PRIVATE KEY-----" + "`n"
- ps: Set-Content c:\users\appveyor\.ssh\id_rsa $fileContent
- ps: >-
    Install-Product node 6

    $ENV:PATH="C:\Ruby200-x64\bin;C:\Python27-x64;$ENV:PATH"

build_script:
- npm i
- npm run build
- npm install -g
- ls c:\users\appveyor\.ssh\
- type config set ssh_key_file c:\users\appveyor\.ssh\id_rsa
- bit config set ssh_key_file c:\users\appveyor\.ssh\id_rsa

test_script:
  - npm run test:appveyor
  - npm run e2e-test:appveyor

